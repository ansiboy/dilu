"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),dilu;!function(dilu){dilu.errors={argumentNull:function(parameterName){var msg="Parameter "+parameterName+" can not be null or empty.";return new Error(msg)},elementValidateRuleNotSet:function(element){var msg="元素'"+element.name+"'没有设置验证规则";return new Error(msg)},fieldElementCanntNull:function(fieldIndex){var msg=null!=fieldIndex?"The element value in the field cannt be null, field index is "+fieldIndex+".":"The element in the field is null";return new Error(msg)},elementNotExists:function(name){var msg="Element "+name+" is not exits in the form.";return new Error(msg)},fieldResultExpectBooleanType:function(name){var msg="Result of "+name+" field is expected boolean.";return new Error(msg)}}}(dilu||(dilu={}));var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},dilu;!function(dilu){var FormValidator=function(){function FormValidator(form){_classCallCheck(this,FormValidator),this.validateOnChanged=!0;for(var _len=arguments.length,fields=Array(_len>1?_len-1:0),_key=1;_key<_len;_key++)fields[_key-1]=arguments[_key];this.fields=fields||[],this.form=form,this.elementEvents={}}return _createClass(FormValidator,[{key:"appendField",value:function(field){this.fields.push(field)}},{key:"clearErrors",value:function(){this.fields.map(function(o){return o.errorElement}).filter(function(o){return null!=o}).forEach(function(o){return o.style.display="none"})}},{key:"clearElementError",value:function(name){if(!name)throw dilu.errors.argumentNull("name");var fields=this.fields.filter(function(o){return o.name==name}),_iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var _step,_iterator=fields[Symbol.iterator]();!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=!0){var field=_step.value,errorElement=this.fieldErrorElement(field);errorElement.style.display="none"}}catch(err){_didIteratorError=!0,_iteratorError=err}finally{try{!_iteratorNormalCompletion&&_iterator["return"]&&_iterator["return"]()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"setElementError",value:function(name,error){if(!name)throw dilu.errors.argumentNull("name");if(!error)throw dilu.errors.argumentNull("error");var fields=this.fields.filter(function(o){return o.name==name}),_iteratorNormalCompletion2=!0,_didIteratorError2=!1,_iteratorError2=void 0;try{for(var _step2,_iterator2=fields[Symbol.iterator]();!(_iteratorNormalCompletion2=(_step2=_iterator2.next()).done);_iteratorNormalCompletion2=!0){var field=_step2.value,errorElement=this.fieldErrorElement(field);errorElement.style.removeProperty("display"),errorElement.innerHTML=error}}catch(err){_didIteratorError2=!0,_iteratorError2=err}finally{try{!_iteratorNormalCompletion2&&_iterator2["return"]&&_iterator2["return"]()}finally{if(_didIteratorError2)throw _iteratorError2}}}},{key:"fieldElement",value:function(field){var name=field.name,element=this.form.querySelectorAll("[name='"+name+"']")[0];if(null==element)throw dilu.errors.elementNotExists(name);return element}},{key:"fieldErrorElement",value:function(field){if(field.errorElement)return field.errorElement;var element=this.fieldElement(field),errorElement=field.errorElement=document.createElement("span");return errorElement.className=FormValidator.errorClassName,errorElement.style.display="none",element.nextSibling?element.parentElement.insertBefore(errorElement,element.nextSibling):element.parentElement.appendChild(errorElement),errorElement}},{key:"check",value:function(){for(var ps=new Array,i=0;i<this.fields.length;i++){var field=this.fields[i];if(!field.condition||0!=field.condition()){var p=this.checkField(field);ps.push(p)}}var result=0==ps.filter(function(o){return 0==o}).length;return result}},{key:"checkAsync",value:function(){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee(){var ps,i,field,p,checkResults,result;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:ps=new Array,i=0;case 2:if(!(i<this.fields.length)){_context.next=11;break}if(field=this.fields[i],!field.condition||0!=field.condition()){_context.next=6;break}return _context.abrupt("continue",8);case 6:p=this.checkFieldAsync(field),ps.push(p);case 8:i++,_context.next=2;break;case 11:return _context.next=13,Promise.all(ps);case 13:return checkResults=_context.sent,result=0==checkResults.filter(function(o){return 0==o}).length,_context.abrupt("return",result);case 16:case"end":return _context.stop()}},_callee,this)}))}},{key:"bindElementEvent",value:function(field,isAsync){var _this=this;if(!this.elementEvents[field.name]){var element=this.fieldElement(field),validateFunc=function(){var checking=!1;return function(){checking||(checking=!0,isAsync?_this.checkFieldAsync(field).then(function(){return checking=!1})["catch"](function(){return checking=!1}):(_this.checkField(field),checking=!1))}}();this.validateOnChanged&&(element.addEventListener("change",validateFunc),"select"!=element.tagName&&element.addEventListener("keyup",validateFunc)),this.elementEvents[field.name]=!0}}},{key:"checkField",value:function(field){this.bindElementEvent(field,!1);for(var depends=field.depends||[],j=0;j<depends.length;j++){var dependResult=depends[j]();if("object"==("undefined"==typeof dependResult?"undefined":_typeof(dependResult)))throw new Error("Please use checkAsync method.");var dependIsOK=dependResult;if(!dependIsOK)return!1}for(var _j=0;_j<field.rules.length;_j++){var rule=field.rules[_j],element=this.fieldElement(field);if(null==element)throw dilu.errors.fieldElementCanntNull();var value=FormValidator.elementValue(element),isPass=rule.validate(value);if("object"==("undefined"==typeof isPass?"undefined":_typeof(isPass)))throw new Error("Please use checkAsync method.");if(this.showElement(!isPass,field,rule,element),!isPass)return!1}return!0}},{key:"checkFieldAsync",value:function(field){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee2(){var depends,j,dependResult,dependIsOK,_j2,rule,element,value,p,isPass;return regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:this.bindElementEvent(field,!0),depends=field.depends||[],j=0;case 3:if(!(j<depends.length)){_context2.next=14;break}return dependResult=depends[j](),"boolean"==typeof dependResult&&(dependResult=Promise.resolve(dependResult)),_context2.next=8,dependResult;case 8:if(dependIsOK=_context2.sent){_context2.next=11;break}return _context2.abrupt("return",!1);case 11:j++,_context2.next=3;break;case 14:_j2=0;case 15:if(!(_j2<field.rules.length)){_context2.next=32;break}if(rule=field.rules[_j2],element=this.fieldElement(field),null!=element){_context2.next=20;break}throw dilu.errors.fieldElementCanntNull();case 20:return value=FormValidator.elementValue(element),p=rule.validate(value),"boolean"==typeof p&&(p=Promise.resolve(p)),_context2.next=25,p;case 25:if(isPass=_context2.sent,this.showElement(!isPass,field,rule,element),isPass){_context2.next=29;break}return _context2.abrupt("return",!1);case 29:_j2++,_context2.next=15;break;case 32:return _context2.abrupt("return",!0);case 33:case"end":return _context2.stop()}},_callee2,this)}))}},{key:"showElement",value:function(display,field,rule,element){var errorElement=this.fieldErrorElement(field);if(console.assert(null!=errorElement,"errorElement cannt be null."),null!=rule.error){errorElement=field.errorElement;var name=this.elementName(element),errorText="string"==typeof rule.error?rule.error:rule.error()||"";errorElement.innerHTML=errorText.replace("%s",name)}display?errorElement.style.removeProperty("display"):errorElement.style.display="none"}},{key:"checkElementAsync",value:function(name){var field=this.fields.filter(function(o){return o.name==name})[0];if(!field)throw dilu.errors.elementNotExists(name);return this.checkFieldAsync(field)}},{key:"checkElement",value:function(name){var field=this.fields.filter(function(o){return o.name==name})[0];if(!field)throw dilu.errors.elementNotExists(name);return this.checkField(field)}},{key:"elementName",value:function(element){return"TEXTAREA"==element.tagName?element.name:element.name}}],[{key:"elementValue",value:function(element){return"TEXTAREA"==element.tagName?element.value:element.value}}]),FormValidator}();FormValidator.errorClassName="validationMessage",dilu.FormValidator=FormValidator}(dilu||(dilu={}));var dilu;!function(dilu){function createValidation(validate,error){return{validate:validate,error:error}}function calc(value){return"function"==typeof value?value():value}function elementValueCompare(value,otherValue){var elementValue=void 0;return elementValue="number"==typeof otherValue?decimalRegex.test(value)?parseFloat(value):null:"string"==typeof otherValue?value:getValidDate(value),elementValue<otherValue?"lessThan":elementValue>otherValue?"greaterThan":"equal"}function getValidDate(date){if(!date.match("today")&&!date.match(dateRegex))return null;var validDateArray,validDate=new Date;return date.match("today")||(validDateArray=date.split("-"),validDate.setFullYear(validDateArray[0]),validDate.setMonth(validDateArray[1]-1),validDate.setDate(validDateArray[2])),validDate}var numericRegex=/^[0-9]+$/,decimalRegex=/^\-?[0-9]*\.?[0-9]+$/,emailRegex=/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/,ipRegex=/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/i,urlRegex=/^((http|https):\/\/(\w+:{0,1}\w*@)?(\S+)|)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/,mobileRegex=/^1[34578]\d{9}$/,dateRegex=/\d{4}-\d{1,2}-\d{1,2}/,msgs={required:"%s不能为空",matches:"%s与%s不匹配","default":"The %s field is still set to default, please change.",equal:"%s和%s必须相同",email:"不是有效的邮箱地址",valid_emails:"The %s field must contain all valid email addresses.",minLength:"%s至少包含%s个字符",maxLength:"%s不能超过%s字符",exact_length:"The %s field must be exactly %s characters in length.",greater_than:"The %s field must contain a number greater than %s.",less_than:"The %s field must contain a number less than %s.",alpha:"The %s field must only contain alphabetical characters.",alpha_numeric:"The %s field must only contain alpha-numeric characters.",alpha_dash:"The %s field must only contain alpha-numeric characters, underscores, and dashes.",numeric:"请数入数字",integer:"The %s field must contain an integer.",decimal:"The %s field must contain a decimal number.",is_natural:"The %s field must contain only positive numbers.",is_natural_no_zero:"The %s field must contain a number greater than zero.",ip:"The %s field must contain a valid IP.",valid_base64:"The %s field must contain a base64 string.",valid_credit_card:"The %s field must contain a valid credit card number.",is_file_type:"The %s field must contain only %s files.",valid_url:"The %s field must contain a valid URL.",greater_than_date:"The %s field must contain a more recent date than %s.",less_than_date:"The %s field must contain an older date than %s.",greater_than_or_equal_date:"The %s field must contain a date that's at least as recent as %s.",less_than_or_equal_date:"The %s field must contain a date that's %s or older.",mobile:"请输入正确的手机号码",custom:"请输入正确制"};dilu.rules={required:function(error){var validate=function(value){return""!=value};return createValidation(validate,error||msgs.required)},matches:function(otherElement,error){var validate=function(value){return value==dilu.FormValidator.elementValue(otherElement)};return createValidation(validate,error||msgs.required)},email:function(error){var validate=function(value){return emailRegex.test(value)};return createValidation(validate,error||msgs.required)},minLength:function(length,error){var validate=function(value){return(value||"").length>=calc(length)};return createValidation(validate,error||msgs.minLength)},maxLength:function(length,error){var validate=function(value){return(value||"").length<=calc(length)};return createValidation(validate,error||msgs.matches)},greaterThan:function(value,error){var validate=function(o){return"greaterThan"==elementValueCompare(o,calc(value))};return createValidation(validate,error||msgs.greater_than)},lessThan:function(value,error){var validate=function(o){return"lessThan"==elementValueCompare(o,calc(value))};return createValidation(validate,error||msgs.less_than)},equal:function(value,error){var validate=function(o){return"equal"==elementValueCompare(o,calc(value))};return createValidation(validate,error||msgs.equal)},ip:function(error){var validate=function(value){return ipRegex.test(value)};return createValidation(validate,error||msgs.ip)},url:function(error){var validate=function(value){return urlRegex.test(value)};return createValidation(validate,error||msgs.valid_url)},mobile:function(error){var validate=function(value){return mobileRegex.test(value)};return createValidation(validate,error||msgs.mobile)},numeric:function(error){var validate=function(value){return numericRegex.test(value)};return createValidation(validate,error||msgs.numeric)},custom:function(validate,error){return createValidation(validate,error||msgs.custom)}}}(dilu||(dilu={}));